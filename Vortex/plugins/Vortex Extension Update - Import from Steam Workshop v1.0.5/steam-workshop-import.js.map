{"version":3,"sources":["webpack://steam-workshop-import/webpack/bootstrap","webpack://steam-workshop-import/./src/index.ts","webpack://steam-workshop-import/./src/util/import.ts","webpack://steam-workshop-import/./src/util/workshopUtil.ts","webpack://steam-workshop-import/./src/views/WorkshopImport.tsx","webpack://steam-workshop-import/external \"bluebird\"","webpack://steam-workshop-import/external \"https\"","webpack://steam-workshop-import/external \"path\"","webpack://steam-workshop-import/external \"querystring\"","webpack://steam-workshop-import/external \"react\"","webpack://steam-workshop-import/external \"react-bootstrap\"","webpack://steam-workshop-import/external \"react-i18next\"","webpack://steam-workshop-import/external \"react-redux\"","webpack://steam-workshop-import/external \"vortex-api\""],"names":[],"mappings":";;QAAA;QACA;;QAEA;QACA;;QAEA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;;QAEA;QACA;;QAEA;QACA;;QAEA;QACA;QACA;;;QAGA;QACA;;QAEA;QACA;;QAEA;QACA;QACA;QACA,0CAA0C,gCAAgC;QAC1E;QACA;;QAEA;QACA;QACA;QACA,wDAAwD,kBAAkB;QAC1E;QACA,iDAAiD,cAAc;QAC/D;;QAEA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA,yCAAyC,iCAAiC;QAC1E,gHAAgH,mBAAmB,EAAE;QACrI;QACA;;QAEA;QACA;QACA;QACA,2BAA2B,0BAA0B,EAAE;QACvD,iCAAiC,eAAe;QAChD;QACA;QACA;;QAEA;QACA,sDAAsD,+DAA+D;;QAErH;QACA;;;QAGA;QACA;;;;;;;;;;;;;AClFa;AACb;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,4CAA4C;AAC5C;AACA,8CAA8C,cAAc;AAC5D,qBAAqB,mBAAO,CAAC,8BAAY;AACzC,0BAA0B,mBAAO,CAAC,kBAAM;AACxC,yCAAyC,mBAAO,CAAC,8DAAwB;AACzE;AACA;AACA;AACA;AACA;AACA;AACA;AACA,yDAAyD;AACzD;AACA,KAAK;AACL;AACA;AACA,KAAK;AACL;AACA;AACA,KAAK;AACL;AACA;AACA;;;;;;;;;;;;;ACjCa;AACb;AACA,4CAA4C;AAC5C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,8CAA8C,cAAc;AAC5D,mCAAmC,mBAAO,CAAC,0BAAU;AACrD,0BAA0B,mBAAO,CAAC,kBAAM;AACxC,qBAAqB,mBAAO,CAAC,8BAAY;AACzC;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kCAAkC,oBAAoB;AACtD;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA;AACA,SAAS;AACT,KAAK;AACL;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AChEa;AACb;AACA;AACA;AACA;AACA;AACA;AACA;AACA,8CAA8C,cAAc;AAC5D,qBAAqB,mBAAO,CAAC,8BAAY;AACzC,0BAA0B,mBAAO,CAAC,kBAAM;AACxC,2BAA2B,mBAAO,CAAC,oBAAO;AAC1C,iCAAiC,mBAAO,CAAC,gCAAa;AACtD;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA,4BAA4B;AAC5B,oEAAoE,IAAI;AACxE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iBAAiB;AACjB,aAAa;AACb;AACA;AACA;AACA,SAAS;AACT,KAAK;AACL;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA,KAAK;AACL;AACA;;;;;;;;;;;;;AC5Ea;AACb;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,4CAA4C;AAC5C;AACA,8CAA8C,cAAc;AAC5D,qBAAqB,mBAAO,CAAC,8BAAY;AACzC,wBAAwB,mBAAO,CAAC,oCAAe;AAC/C,sBAAsB,mBAAO,CAAC,gCAAa;AAC3C,2BAA2B,mBAAO,CAAC,oBAAO;AAC1C,0BAA0B,mBAAO,CAAC,wCAAiB;AACnD,oCAAoC,mBAAO,CAAC,wDAAsB;AAClE,iCAAiC,mBAAO,CAAC,4CAAgB;AACzD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,mBAAmB,aAAa;AAChC;AACA;AACA;AACA;AACA,mBAAmB,aAAa;AAChC;AACA;AACA;AACA;AACA;AACA;AACA,6BAA6B;AAC7B;AACA;AACA;AACA,4BAA4B;AAC5B,SAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,eAAe,IAAI;AACnB,eAAe,iCAAiC;AAChD;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA,eAAe,eAAe;AAC9B,eAAe,OAAO;AACtB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA,eAAe,IAAI;AACnB,eAAe,6BAA6B;AAC5C;AACA;AACA;AACA,uCAAuC;AACvC,SAAS;AACT;AACA;AACA;AACA,SAAS;AACT;AACA;AACA;AACA,eAAe,4CAA4C;AAC3D;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA;AACA;AACA;AACA,eAAe,aAAa;AAC5B,eAAe,oBAAoB;AACnC;AACA,yDAAyD,gEAAgE;AACzH;AACA;AACA;AACA;AACA;AACA,+DAA+D,6CAA6C;AAC5G,+DAA+D,4DAA4D;AAC3H,+DAA+D,oDAAoD;AACnH;AACA;AACA,eAAe,sEAAsE;AACrF;AACA;AACA;AACA;AACA;AACA;AACA,eAAe,oBAAoB;AACnC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,eAAe,IAAI;AACnB,eAAe,aAAa;AAC5B,yDAAyD,2BAA2B,mBAAmB,EAAE;AACzG,0DAA0D,mFAAmF;AAC7I,0DAA0D,4FAA4F;AACtJ,0DAA0D,yFAAyF;AACnJ,0DAA0D,+GAA+G;AACzK,0DAA0D,uFAAuF;AACjJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,4CAA4C,uCAAuC;AACnF,uDAAuD,iCAAiC;AACxF;AACA;AACA,eAAe,IAAI;AACnB,eAAe,eAAe;AAC9B,6CAA6C,8BAA8B;AAC3E,wCAAwC,gBAAgB,UAAU,uBAAuB;AACzF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,8CAA8C,qDAAqD;AACnG;AACA;AACA,eAAe,IAAI;AACnB,eAAe,WAAW;AAC1B;AACA;AACA;AACA,4CAA4C,yCAAyC;AACrF,wEAAwE,KAAK,IAAI,WAAW,oBAAoB,EAAE;AAClH,gEAAgE,sBAAsB,KAAK,IAAI;AAC/F;AACA;AACA,eAAe,IAAI;AACnB,eAAe,wBAAwB;AACvC,4CAA4C,SAAS,0EAA0E,EAAE;AACjI,qDAAqD,iIAAiI;AACtL;AACA;AACA,eAAe,IAAI;AACnB,eAAe,oCAAoC;AACnD,4CAA4C,yCAAyC;AACrF;AACA;AACA;AACA;AACA,0CAA0C,kHAAkH;AAC5J,2DAA2D,mEAAmE;AAC9H,wCAAwC,sCAAsC;AAC9E;AACA;AACA;AACA;AACA;AACA;AACA,sCAAsC,qDAAqD;AAC3F;AACA;AACA,eAAe,IAAI;AACnB;AACA,0GAA0G,oBAAoB;AAC9H,gEAAgE,2BAA2B;AAC3F,4DAA4D,UAAU;AACtE,gDAAgD,+BAA+B,sCAAsC,EAAE;AACvH,4DAA4D,UAAU;AACtE,4DAA4D,UAAU;AACtE,mEAAmE,oBAAoB;AACvF,SAAS;AACT;AACA;AACA;AACA,eAAe,IAAI;AACnB,eAAe,gBAAgB;AAC/B,4CAA4C,yCAAyC;AACrF,4CAA4C,8BAA8B;AAC1E,wDAAwD,2BAA2B;AACnF;AACA,4CAA4C,6BAA6B;AACzE,wDAAwD,yBAAyB;AACjF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iBAAiB;AACjB;AACA,aAAa;AACb;AACA;AACA;AACA;AACA;AACA;AACA,iBAAiB;AACjB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,yBAAyB,6BAA6B;AACtD,yBAAyB;AACzB;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,wBAAwB;AACxB;AACA,2DAA2D,sBAAsB;AACjF;AACA,aAAa;AACb;AACA;AACA;AACA;AACA;AACA;AACA,mGAAmG,wBAAwB,oBAAoB,oIAAoI;AACnR,iBAAiB;AACjB;AACA;AACA;AACA;AACA;AACA,aAAa;AACb;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iBAAiB;AACjB;AACA;AACA;AACA;AACA;AACA,aAAa;AACb;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kCAAkC,oBAAoB;AACtD;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,+FAA+F;AAC/F,iFAAiF;AACjF;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACzaA,qC;;;;;;;;;;;ACAA,kC;;;;;;;;;;;ACAA,iC;;;;;;;;;;;ACAA,wC;;;;;;;;;;;ACAA,kC;;;;;;;;;;;ACAA,4C;;;;;;;;;;;ACAA,0C;;;;;;;;;;;ACAA,wC;;;;;;;;;;;ACAA,uC","file":"index.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = \"./src/index.ts\");\n","\"use strict\";\r\nvar __importStar = (this && this.__importStar) || function (mod) {\r\n    if (mod && mod.__esModule) return mod;\r\n    var result = {};\r\n    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];\r\n    result[\"default\"] = mod;\r\n    return result;\r\n};\r\nvar __importDefault = (this && this.__importDefault) || function (mod) {\r\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\r\n};\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nconst vortex_api_1 = require(\"vortex-api\");\r\nconst path = __importStar(require(\"path\"));\r\nconst WorkshopImport_1 = __importDefault(require(\"./views/WorkshopImport\"));\r\nconst supportedGameIds = ['skyrim', 'ahatintime', 'enderal', 'darkestdungeon', 'dawnofman', 'divinityoriginalsin2', 'divinityoriginalsin2definitiveedition', 'faleanniversary', 'galacticcivilisations3', 'kenshi',\r\n    'kerbalspaceprogram', 'legendofgrimrock', 'mbwarband', 'neverwinternightsenhancededition', 'oxygennotincluded', 'payday2', 'pillarsofeternity2deadfire', 'portal2', 'prisonarchitect',\r\n    'rimworld', 'x4foundations', 'xcom2'];\r\nfunction main(context) {\r\n    if (process.platform !== \"win32\")\r\n        return false;\r\n    context.registerDialog('workshop-import', WorkshopImport_1.default);\r\n    context.registerAction('mod-icons', 120, 'import', {}, 'Import From Steam Workshop', () => {\r\n        context.api.store.dispatch(vortex_api_1.actions.setDialogVisible('workshop-import'));\r\n    }, (instanceIds) => {\r\n        const gameId = vortex_api_1.selectors.activeGameId(context.api.store.getState());\r\n        return supportedGameIds.includes(gameId);\r\n    });\r\n    context.once(() => {\r\n        context.api.setStylesheet('workshop-import', path.join(__dirname, 'workshop-import.scss'));\r\n    });\r\n    return true;\r\n}\r\nexports.default = main;\r\n","\"use strict\";\r\nvar __importDefault = (this && this.__importDefault) || function (mod) {\r\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\r\n};\r\nvar __importStar = (this && this.__importStar) || function (mod) {\r\n    if (mod && mod.__esModule) return mod;\r\n    var result = {};\r\n    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];\r\n    result[\"default\"] = mod;\r\n    return result;\r\n};\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nconst bluebird_1 = __importDefault(require(\"bluebird\"));\r\nconst path = __importStar(require(\"path\"));\r\nconst vortex_api_1 = require(\"vortex-api\");\r\nfunction importMods(t, store, wsBasePath, mods, progress) {\r\n    const gameId = vortex_api_1.selectors.activeGameId(store.getState());\r\n    const errors = [];\r\n    vortex_api_1.log('debug', 'Steam Workshop import starting');\r\n    const installPath = vortex_api_1.selectors.installPath(store.getState());\r\n    return bluebird_1.default.mapSeries(mods, (mod, idx, len) => {\r\n        vortex_api_1.log('debug', 'transferring', mod);\r\n        const vortexId = `steam-${mod.publishedfileid}`;\r\n        progress(mod.title, idx / len);\r\n        return transferMod(mod, wsBasePath, installPath, vortexId)\r\n            .then(() => bluebird_1.default.resolve(''))\r\n            .catch(err => {\r\n            vortex_api_1.log('debug', 'Failed to import', err);\r\n            errors.push(mod.title);\r\n        })\r\n            .then(() => {\r\n            store.dispatch(vortex_api_1.actions.addMod(gameId, toVortexMod(mod, vortexId)));\r\n            return bluebird_1.default.resolve();\r\n        });\r\n    })\r\n        .then(() => {\r\n        vortex_api_1.log('debug', 'Finished importing');\r\n        return errors;\r\n    });\r\n}\r\nfunction transferMod(mod, wsPath, installPath, vortexId) {\r\n    const sourcePath = path.join(wsPath, mod.publishedfileid);\r\n    const destinationPath = path.join(installPath, vortexId);\r\n    return vortex_api_1.util.copyRecursive(sourcePath, destinationPath);\r\n}\r\nfunction toVortexMod(mod, vortexId) {\r\n    const vortexMod = {\r\n        id: vortexId,\r\n        state: 'installed',\r\n        type: '',\r\n        installationPath: vortexId,\r\n        attributes: {\r\n            name: mod.title,\r\n            author: 'Steam Workshop',\r\n            description: mod.description,\r\n            pictureUrl: mod.preview_url,\r\n            installTime: new Date(),\r\n            version: '1.0.0',\r\n            notes: 'Imported from Steam Workshop',\r\n            steamWorkshopId: mod.publishedfileid\r\n        }\r\n    };\r\n    return vortexMod;\r\n}\r\nexports.default = importMods;\r\n","\"use strict\";\r\nvar __importStar = (this && this.__importStar) || function (mod) {\r\n    if (mod && mod.__esModule) return mod;\r\n    var result = {};\r\n    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];\r\n    result[\"default\"] = mod;\r\n    return result;\r\n};\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nconst vortex_api_1 = require(\"vortex-api\");\r\nconst path = __importStar(require(\"path\"));\r\nconst https = __importStar(require(\"https\"));\r\nconst querystring = __importStar(require(\"querystring\"));\r\nconst steamRequestOptions = {\r\n    hostname: 'api.steampowered.com',\r\n    port: 443,\r\n    path: '/ISteamRemoteStorage/GetPublishedFileDetails/v1/',\r\n    method: 'POST',\r\n    headers: {\r\n        'Content-Type': 'application/x-www-form-urlencoded',\r\n    },\r\n};\r\nfunction getWorkshopModData(workshopPath) {\r\n    return vortex_api_1.fs.readdirAsync(workshopPath)\r\n        .then((workshopIds) => {\r\n        if (!workshopIds || !workshopIds.length)\r\n            return Promise.resolve([]);\r\n        const dataObject = { 'itemcount': workshopIds.length };\r\n        workshopIds.map((id, idx) => dataObject[`publishedfileids[${idx}]`] = id);\r\n        const data = querystring.stringify(dataObject);\r\n        steamRequestOptions.headers['Content-size'] = data.length;\r\n        return new Promise((resolve, reject) => {\r\n            const req = https.request(steamRequestOptions, (res) => {\r\n                let rawData = '';\r\n                res.on('data', d => rawData += d);\r\n                res.on('end', () => {\r\n                    var _a;\r\n                    const reply = JSON.parse(rawData);\r\n                    if (!((_a = reply.response) === null || _a === void 0 ? void 0 : _a.publishedfiledetails)) {\r\n                        const err = new Error('The Steam API returned an invalid response, please report this error including your Vortex.log file.');\r\n                        err.code = 'STEAMAPIERROR';\r\n                        vortex_api_1.log('error', 'Steam API response did not contain publishedfiledetails', (reply.response || reply));\r\n                        return reject(err);\r\n                    }\r\n                    const mappedData = workshopIds.map(id => reply.response.publishedfiledetails.find(file => file.publishedfileid === id));\r\n                    return resolve(mappedData);\r\n                });\r\n            });\r\n            req.on('error', (error) => reject(error));\r\n            req.write(data);\r\n            req.end();\r\n        }).catch(err => Promise.reject(err));\r\n    })\r\n        .catch(err => {\r\n        Promise.reject(err);\r\n    });\r\n}\r\nexports.getWorkshopModData = getWorkshopModData;\r\nfunction findWorkshopPath(games, gameId, steamAppId) {\r\n    if (!steamAppId)\r\n        return Promise.reject('NON_STEAM');\r\n    const gamePath = games[gameId].path;\r\n    if (gamePath.indexOf('steamapps') === -1)\r\n        return Promise.reject('NON_STEAM');\r\n    const steamApps = gamePath.substr(0, gamePath.indexOf('steamapps') + 9);\r\n    const steamWorkshopFolder = path.join(steamApps, 'workshop', 'content', steamAppId.toString());\r\n    return vortex_api_1.fs.readdirAsync(steamWorkshopFolder)\r\n        .then((dirs) => {\r\n        if (!dirs.length)\r\n            return Promise.reject('NO_MODS');\r\n        return Promise.resolve(steamWorkshopFolder);\r\n    })\r\n        .catch(err => {\r\n        return Promise.reject(err);\r\n    });\r\n}\r\nexports.default = findWorkshopPath;\r\n","\"use strict\";\r\nvar __importStar = (this && this.__importStar) || function (mod) {\r\n    if (mod && mod.__esModule) return mod;\r\n    var result = {};\r\n    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];\r\n    result[\"default\"] = mod;\r\n    return result;\r\n};\r\nvar __importDefault = (this && this.__importDefault) || function (mod) {\r\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\r\n};\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nconst vortex_api_1 = require(\"vortex-api\");\r\nconst react_i18next_1 = require(\"react-i18next\");\r\nconst react_redux_1 = require(\"react-redux\");\r\nconst React = __importStar(require(\"react\"));\r\nconst react_bootstrap_1 = require(\"react-bootstrap\");\r\nconst workshopUtil_1 = __importStar(require(\"../util/workshopUtil\"));\r\nconst import_1 = __importDefault(require(\"../util/import\"));\r\nclass ImportDialog extends vortex_api_1.ComponentEx {\r\n    constructor(props) {\r\n        super(props);\r\n        this.nop = () => undefined;\r\n        this.cancel = () => {\r\n            this.props.onHide();\r\n        };\r\n        this.next = () => {\r\n            const { importStep } = this.state;\r\n            const currentIdx = ImportDialog.STEPS.indexOf(importStep);\r\n            this.setStep(ImportDialog.STEPS[currentIdx + 1]);\r\n        };\r\n        this.previous = () => {\r\n            const { importStep } = this.state;\r\n            const currentIdx = ImportDialog.STEPS.indexOf(importStep);\r\n            this.setStep(ImportDialog.STEPS[currentIdx - 1]);\r\n        };\r\n        this.initState({\r\n            importStep: undefined,\r\n            importArchives: true,\r\n            importEnabled: {},\r\n            workshopPath: undefined,\r\n            failedImports: [],\r\n            counter: 0,\r\n            modsToImport: {},\r\n        });\r\n        this.mActions = this.genActions();\r\n        this.mAttributes = this.genAttributes();\r\n    }\r\n    ;\r\n    UNSAFE_componentWillReceiveProps(newProps) {\r\n        if (!this.props.visible && newProps.visible) {\r\n            this.start();\r\n        }\r\n    }\r\n    start() {\r\n        const { t } = this.props;\r\n        const { discovered, gameId, steamAppId } = this.props;\r\n        this.nextState.importStep = 'start';\r\n        this.nextState.error = undefined;\r\n        return workshopUtil_1.default(discovered, gameId, steamAppId)\r\n            .then(found => {\r\n            this.nextState.workshopPath = found;\r\n        })\r\n            .catch(err => {\r\n            if (err === 'NON_STEAM') {\r\n                this.nextState.error = (React.createElement(\"span\", null,\r\n                    React.createElement(\"h3\", null, t('Steam Workshop folder not found')),\r\n                    t('This game is not installed via Steam or the Steam App ID is not definied in the extension.')));\r\n            }\r\n            else if (err.code === 'ENOENT') {\r\n                this.nextState.error = (React.createElement(\"span\", null,\r\n                    React.createElement(\"h3\", null, t('Steam Workshop folder not found')),\r\n                    t('The Steam Workshop folder does not exist for this game. This could mean that this game is not installed through Steam or you do not have any mods from the Workshop.')));\r\n            }\r\n            else if (err === 'NO_MODS') {\r\n                this.nextState.error = (React.createElement(\"span\", null,\r\n                    React.createElement(\"h3\", null, t('No Workshop mods installed')),\r\n                    t('It doesn\\'t look like you have any Steam Workshop mods installed at the moment.')));\r\n            }\r\n            else {\r\n                this.nextState.error = (React.createElement(\"span\", null,\r\n                    React.createElement(\"h3\", null, t('Unknown error')),\r\n                    t('An error occured accessing your Steam Workshop folder:'),\r\n                    \" \",\r\n                    err.message,\r\n                    \".\"));\r\n            }\r\n        });\r\n    }\r\n    setup() {\r\n        const { workshopPath } = this.state;\r\n        const { mods } = this.props;\r\n        const vortexState = this.context.api.store.getState();\r\n        const networkConnected = vortexState.session.base.networkConnected;\r\n        if (!networkConnected) {\r\n            this.nextState.error = (React.createElement(\"span\", null,\r\n                React.createElement(\"h2\", null, \"No network connection\"),\r\n                \"Vortex is currently offline. An internet connection is required to use this feature.\"));\r\n            return Promise.resolve();\r\n        }\r\n        return workshopUtil_1.getWorkshopModData(workshopPath)\r\n            .then((workshopMods) => this.nextState.modsToImport = convertWorkshopMods(workshopMods, mods))\r\n            .catch(err => {\r\n            if (err.code === 'ENOTFOUND')\r\n                return this.nextState.error = (React.createElement(\"span\", null,\r\n                    React.createElement(\"h3\", null, \"Steam API could not be reached\"),\r\n                    \"Please ensure you have an internet connection to use the feature.\"));\r\n            else\r\n                this.nextState.error = React.createElement(\"p\", null,\r\n                    \"Error getting workshop mod data: \",\r\n                    err.code,\r\n                    \" \",\r\n                    err.message);\r\n        });\r\n    }\r\n    startImport() {\r\n        const { t } = this.props;\r\n        const { modsToImport, workshopPath } = this.state;\r\n        const modList = modsToImport ? Object.keys(modsToImport).map(id => modsToImport[id]) : [];\r\n        const enabledMods = modList.filter(mod => this.isModEnabled(mod));\r\n        import_1.default(t, this.context.api.store, workshopPath, enabledMods, (mod, perc) => {\r\n            this.nextState.progress = { mod, perc };\r\n        })\r\n            .then(errors => {\r\n            this.nextState.failedImports = errors;\r\n            this.setStep('cleanup');\r\n        });\r\n        return Promise.resolve();\r\n    }\r\n    cleanupCheck() {\r\n        const { modsToImport, workshopPath, failedImports } = this.state;\r\n        const modList = Object.keys(modsToImport).map(id => modsToImport[id]);\r\n        const enabledMods = modList.filter(mod => this.isModEnabled(mod) && !failedImports.includes(mod.title));\r\n        if (!enabledMods.length) {\r\n            this.setStep('review');\r\n            return Promise.resolve();\r\n        }\r\n        const modIds = enabledMods.map(mod => mod.publishedfileid);\r\n        return vortex_api_1.fs.readdirAsync(workshopPath)\r\n            .then((folders) => {\r\n            if (!folders.length)\r\n                return this.setStep('review');\r\n            const pending = folders.map(id => modIds.includes(id) ? modsToImport[id] : null).filter(m => m !== null);\r\n            this.nextState.importModsToDisable = pending;\r\n            return Promise.resolve();\r\n        })\r\n            .catch(err => this.nextState.error = (React.createElement(\"span\", null,\r\n            React.createElement(\"h3\", null, \"Unknown error\"),\r\n            err.message)));\r\n    }\r\n    render() {\r\n        const { t, visible } = this.props;\r\n        const { error, importStep } = this.state;\r\n        const canCancel = ['start', 'setup'].indexOf(importStep) !== -1;\r\n        return (React.createElement(vortex_api_1.Modal, { id: 'workshop-import-dialog', show: visible, onHide: this.nop },\r\n            React.createElement(vortex_api_1.Modal.Header, null,\r\n                React.createElement(\"h2\", null, t('Steam Workshop Import Tool')),\r\n                this.renderSteps(importStep)),\r\n            React.createElement(vortex_api_1.Modal.Body, null, error !== undefined ? React.createElement(react_bootstrap_1.Alert, null, error) : this.renderContent(importStep)),\r\n            React.createElement(vortex_api_1.Modal.Footer, null,\r\n                React.createElement(react_bootstrap_1.Button, { disabled: !canCancel, onClick: this.cancel }, t('Cancel')),\r\n                React.createElement(react_bootstrap_1.Button, { disabled: this.previousDisabled(), onClick: this.previous }, t('Previous')),\r\n                React.createElement(react_bootstrap_1.Button, { disabled: this.nextDisabled(), onClick: this.next }, importStep === 'review' ? t('Finish') : t('Next')))));\r\n    }\r\n    nextDisabled() {\r\n        const { error, workshopPath, importStep, importModsToDisable, importEnabled } = this.state;\r\n        return (error !== undefined) || (importStep === 'wait')\r\n            || ((importStep === 'start') && (workshopPath === undefined))\r\n            || ((importStep === \"cleanup\") && (!!importModsToDisable.length))\r\n            || ((importStep === 'setup') && (Object.keys(importEnabled).map(key => importEnabled[key] === true).length) === 0);\r\n    }\r\n    previousDisabled() {\r\n        const { error, importStep } = this.state;\r\n        return (error !== undefined) || (importStep === 'wait') || (importStep === 'start') || (importStep === 'cleanup');\r\n    }\r\n    setStep(newStep) {\r\n        this.nextState.importStep = 'wait';\r\n        let job = Promise.resolve();\r\n        if (newStep === 'start') {\r\n            job = this.start();\r\n        }\r\n        else if (newStep === 'setup') {\r\n            job = this.setup();\r\n        }\r\n        else if (newStep === 'working') {\r\n            job = this.startImport();\r\n        }\r\n        else if (newStep === 'cleanup') {\r\n            job = this.cleanupCheck();\r\n        }\r\n        else if (newStep === undefined) {\r\n            this.props.onHide();\r\n        }\r\n        job.then(() => this.nextState.importStep = newStep);\r\n    }\r\n    renderSteps(step) {\r\n        const { t } = this.props;\r\n        const { importStep } = this.state;\r\n        return (React.createElement(vortex_api_1.Steps, { step: importStep, style: { marginBottom: 32 } },\r\n            React.createElement(vortex_api_1.Steps.Step, { key: 'start', stepId: 'start', title: t('Start'), description: t('Introduction') }),\r\n            React.createElement(vortex_api_1.Steps.Step, { key: 'setup', stepId: 'setup', title: t('Setup'), description: t('Select Mods to import') }),\r\n            React.createElement(vortex_api_1.Steps.Step, { key: 'working', stepId: 'working', title: t('Import'), description: t('Magic happens') }),\r\n            React.createElement(vortex_api_1.Steps.Step, { key: 'cleanup', stepId: 'cleanup', title: t('Cleanup'), description: t('Unsubscribe from the workshop mods') }),\r\n            React.createElement(vortex_api_1.Steps.Step, { key: 'review', stepId: 'review', title: t('Review'), description: t('Import result') })));\r\n    }\r\n    ;\r\n    renderContent(step) {\r\n        switch (step) {\r\n            case 'wait': return this.renderWait();\r\n            case 'start': return this.renderStart();\r\n            case 'setup': return this.renderSelectMods();\r\n            case 'working': return this.renderWorking();\r\n            case 'cleanup': return this.renderCleanup();\r\n            case 'review': return this.renderReview();\r\n            default: return null;\r\n        }\r\n    }\r\n    renderWait() {\r\n        return (React.createElement(\"div\", { className: 'workshop-wait-container' },\r\n            React.createElement(vortex_api_1.Spinner, { className: 'page-wait-spinner' })));\r\n    }\r\n    renderStart() {\r\n        const { t } = this.props;\r\n        const { workshopPath } = this.state;\r\n        return (React.createElement(\"span\", { className: 'workshop-start' },\r\n            React.createElement(\"img\", { src: `file://${__dirname}/steam-to-vortex.png` }),\r\n            React.createElement(\"h3\", null, t('Bring your Workshop mods to Vortex')),\r\n            t('This tool will allow you to import mods installed through Steam Workshop into Vortex.'),\r\n            React.createElement(\"div\", null,\r\n                t('Before you continue, please be aware of the following:'),\r\n                React.createElement(\"ul\", null,\r\n                    React.createElement(\"li\", null, t('If you have a lot of mods, this process can take some time.')),\r\n                    React.createElement(\"li\", null, t('You must be logged into Steam with the user account subscribed to the Workshop items.')),\r\n                    React.createElement(\"li\", null, t('Once your mods have been imported, they will no longer be updated by Steam.')))),\r\n            !workshopPath ? React.createElement(vortex_api_1.Spinner, null)\r\n                : (React.createElement(\"div\", null,\r\n                    t('Your Steam workshop mods have been found in: '),\r\n                    React.createElement(\"a\", { onClick: () => vortex_api_1.util.opn(workshopPath) }, workshopPath)))));\r\n    }\r\n    renderWorking() {\r\n        const { t } = this.props;\r\n        const { progress } = this.state;\r\n        if (progress === undefined)\r\n            return null;\r\n        const perc = Math.floor(progress.perc * 100);\r\n        return (React.createElement(\"div\", { className: 'workshop-import-container' },\r\n            React.createElement(\"span\", null, t('Currently importing: {{mod}}', { replace: { mod: progress.mod } })),\r\n            React.createElement(react_bootstrap_1.ProgressBar, { now: perc, label: `${perc}%` })));\r\n    }\r\n    renderSelectMods() {\r\n        const { t } = this.props;\r\n        const { counter, modsToImport } = this.state;\r\n        return (React.createElement(\"div\", { style: { display: 'flex', flexDirection: 'column', height: '100%', width: '100%' } },\r\n            React.createElement(vortex_api_1.Table, { tableId: 'workshop-mod-imports', data: modsToImport, dataId: counter, actions: this.mActions, staticElements: this.mAttributes })));\r\n    }\r\n    renderCleanup() {\r\n        const { t } = this.props;\r\n        const { importModsToDisable, workshopPath } = this.state;\r\n        return (React.createElement(\"div\", { className: 'workshop-import-container' },\r\n            React.createElement(\"h3\", null, t('Unsubscribe in Steam Workshop')),\r\n            React.createElement(\"p\", null, t('Your Steam Workshop mods have been imported successfully!')),\r\n            React.createElement(\"p\", null, t('Before you continue, you need to unsubscribe from the mods to prevent conflicts with the imported copy.')),\r\n            React.createElement(\"p\", null,\r\n                React.createElement(\"a\", { href: 'steam://openurl/https://steamcommunity.com/id/Silly_zombie/myworkshopfiles?browsefilter=mysubscriptions' }, t('See all subscribed mods in Steam'))),\r\n            React.createElement(react_bootstrap_1.Button, { className: \"refresh-btn\", onClick: () => this.setStep('cleanup') }, t('Refresh')),\r\n            React.createElement(\"div\", { className: 'import-mods-to-disable' }, this.renderModsToDisable(importModsToDisable)),\r\n            React.createElement(\"b\", null, t('Stuck here?')),\r\n            React.createElement(\"p\", null,\r\n                t('If you\\'ve unsubcribed from all the mods but you cannot continue, you\\'ll need to delete the leftover folders in your Workshop directory. The folder names are:'),\r\n                \" \",\r\n                importModsToDisable.map(m => m.publishedfileid).join(', '),\r\n                \" \"),\r\n            React.createElement(\"a\", { onClick: () => vortex_api_1.util.opn(workshopPath) }, \"Open Steam Workshop folder\")));\r\n    }\r\n    renderModsToDisable(mods) {\r\n        const { t } = this.props;\r\n        const listItems = mods.map((mod) => {\r\n            const steamAppUrl = `steam://openurl/https://steamcommunity.com/sharedfiles/filedetails/?id=${mod.publishedfileid}`;\r\n            return (React.createElement(react_bootstrap_1.Row, { key: mod.publishedfileid },\r\n                React.createElement(react_bootstrap_1.Col, { sm: '2' },\r\n                    React.createElement(\"img\", { src: mod.preview_url, style: { maxWidth: '50px', maxHeight: '50px' } })),\r\n                React.createElement(react_bootstrap_1.Col, { sm: '6' }, mod.title),\r\n                React.createElement(react_bootstrap_1.Col, { sm: '4' },\r\n                    React.createElement(react_bootstrap_1.Button, { href: steamAppUrl }, t('Open in Workshop')))));\r\n        });\r\n        return listItems;\r\n    }\r\n    renderReview() {\r\n        const { t } = this.props;\r\n        const { failedImports } = this.state;\r\n        return (React.createElement(\"div\", { className: 'workshop-import-container' }, failedImports.length === 0\r\n            ? (React.createElement(\"span\", { className: 'import-success' },\r\n                React.createElement(vortex_api_1.Icon, { name: 'feedback-success' }),\r\n                t('Import successful')))\r\n            : (React.createElement(\"span\", { className: 'import-errors' },\r\n                React.createElement(vortex_api_1.Icon, { name: 'feedback-error' }),\r\n                t('Import successful')))));\r\n    }\r\n    isModEnabled(mod) {\r\n        return (this.state.importEnabled[mod.publishedfileid] && this.state.importEnabled[mod.publishedfileid] !== false);\r\n    }\r\n    genActions() {\r\n        return [\r\n            {\r\n                icon: 'checkbox-checked',\r\n                title: 'Import',\r\n                action: (instanceIds) => {\r\n                    instanceIds.forEach(id => this.nextState.importEnabled[id] = true);\r\n                    ++this.nextState.counter;\r\n                },\r\n                singleRowAction: false\r\n            },\r\n            {\r\n                icon: 'checkbox-unchecked',\r\n                title: 'Skip',\r\n                action: (instanceIds) => {\r\n                    instanceIds.forEach(id => this.nextState.importEnabled[id] = false);\r\n                    ++this.nextState.counter;\r\n                },\r\n                singleRowAction: false\r\n            }\r\n        ];\r\n    }\r\n    genAttributes() {\r\n        return [\r\n            {\r\n                id: 'status',\r\n                name: 'Import',\r\n                description: 'The import status of this mod.',\r\n                icon: 'level-up',\r\n                calc: mod => this.isModEnabled(mod) ? 'Import' : 'Skip',\r\n                placement: 'table',\r\n                isToggleable: true,\r\n                isSortable: true,\r\n                isVolatile: true,\r\n                edit: {\r\n                    inline: true,\r\n                    choices: () => [\r\n                        { key: 'yes', text: 'Import' },\r\n                        { key: 'no', text: 'Skip' }\r\n                    ],\r\n                    onChangeValue: (mod, value) => {\r\n                        this.nextState.importEnabled[mod.publishedfileid] = !(!!this.state.importEnabled[mod.publishedfileid] && this.state.importEnabled[mod.publishedfileid] !== false);\r\n                        ++this.nextState.counter;\r\n                    }\r\n                }\r\n            },\r\n            {\r\n                id: 'name',\r\n                name: 'Mod Name',\r\n                description: 'The mod title.',\r\n                icon: 'quote-left',\r\n                calc: (mod) => mod.title,\r\n                placement: 'both',\r\n                isToggleable: true,\r\n                isSortable: true,\r\n                filter: new vortex_api_1.TableTextFilter(true),\r\n                edit: {},\r\n                sortFunc: (lhs, rhs, locale) => {\r\n                    return lhs.localeCompare(rhs, locale, { sensitivity: 'base' });\r\n                }\r\n            },\r\n            {\r\n                id: 'exists',\r\n                name: 'Already Imported',\r\n                description: 'Has this mod already been imported?',\r\n                icon: 'level-up',\r\n                customRenderer: (mod, detail) => {\r\n                    return mod.isAlreadyManaged ? (React.createElement(vortex_api_1.tooltip.Icon, { id: `already-managed=${mod.publishedfileid}`, tooltip: 'This mod has already been imported. \\nImporting it again will overwrite the current entry.', name: 'feedback-warning' })) : null;\r\n                },\r\n                calc: mod => mod.isAlreadyManaged,\r\n                placement: 'table',\r\n                isToggleable: true,\r\n                isSortable: true,\r\n                edit: {}\r\n            },\r\n            {\r\n                id: 'id',\r\n                name: 'Workshop ID',\r\n                description: 'The Steam Workshop ID of this mod.',\r\n                icon: 'id-badge',\r\n                calc: (mod) => {\r\n                    try {\r\n                        return parseInt(mod.publishedfileid);\r\n                    }\r\n                    catch (err) {\r\n                        return 0;\r\n                    }\r\n                },\r\n                placement: 'both',\r\n                isToggleable: true,\r\n                isSortable: true,\r\n                isDefaultVisible: false,\r\n                edit: {}\r\n            },\r\n        ];\r\n    }\r\n}\r\nImportDialog.STEPS = ['start', 'setup', 'working', 'cleanup', 'review'];\r\nfunction convertWorkshopMods(mods, vortexMods) {\r\n    const mappedObject = {};\r\n    if (!mods || !mods.length)\r\n        return mappedObject;\r\n    mods.map(mod => {\r\n        mappedObject[mod.publishedfileid] = mod;\r\n        if (!!vortexMods[`steam-${mod.publishedfileid}`])\r\n            mappedObject[mod.publishedfileid].isAlreadyManaged = true;\r\n        return mod;\r\n    });\r\n    return mappedObject;\r\n}\r\nfunction mapStateToProps(state) {\r\n    const gameId = vortex_api_1.selectors.activeGameId(state);\r\n    const game = vortex_api_1.selectors.gameById(state, gameId);\r\n    const steamAppId = vortex_api_1.util.getSafe(game, ['details', 'steamAppId'], undefined);\r\n    return {\r\n        steamAppId,\r\n        gameId,\r\n        discovered: vortex_api_1.util.getSafe(state, ['settings', 'gameMode', 'discovered'], {}),\r\n        mods: vortex_api_1.util.getSafe(state, ['persistent', 'mods', gameId], {})\r\n    };\r\n}\r\nfunction mapDispatchToProps(dispatch) {\r\n    return {};\r\n}\r\nexports.default = react_i18next_1.withTranslation(['common'])(react_redux_1.connect(mapStateToProps, mapDispatchToProps)(ImportDialog));\r\n","module.exports = require(\"bluebird\");","module.exports = require(\"https\");","module.exports = require(\"path\");","module.exports = require(\"querystring\");","module.exports = require(\"react\");","module.exports = require(\"react-bootstrap\");","module.exports = require(\"react-i18next\");","module.exports = require(\"react-redux\");","module.exports = require(\"vortex-api\");"],"sourceRoot":""}